# お問い合わせフォーム実装タスクリスト

**作成日時**: 2025-11-01 21:05
**対象プロジェクト**: next-sendgrid-app

---

## 📋 実装タスク概要

このドキュメントは、お問い合わせフォーム機能の実装に必要なタスクを整理したものです。
各タスクは順序立てて実行することを推奨します。

---

## Phase 1: 基盤構築

### ✅ 完了済み

- [x] プロジェクト概要ドキュメント作成 (CLAUDE.md)
- [x] 要件定義書作成
- [x] 詳細設計書作成

### 🔲 環境設定

#### Task 1.1: 環境変数サンプルファイル作成

**ファイル**:

- `apps/server/.env.example`
- `apps/web/.env.local.example`

**内容**:

```bash
# apps/server/.env.example
SENDGRID_API_KEY=your_sendgrid_api_key_here
FROM_EMAIL=noreply@example.com
ADMIN_EMAIL=admin@example.com
SITE_NAME=サンプルサイト
TURNSTILE_SECRET=your_turnstile_secret_here
CORS_ORIGIN=http://localhost:3001

# apps/web/.env.local.example
NEXT_PUBLIC_TURNSTILE_SITE_KEY=your_turnstile_site_key_here
NEXT_PUBLIC_SERVER_URL=http://localhost:3000
```

**優先度**: 🔴 高
**所要時間**: 5 分
1ws2x

---

## Phase 2: バックエンド実装

### Task 2.1: 共通スキーマ定義

**ファイル**: `packages/api/src/schemas/contact.ts`

**実装内容**:

- zod スキーマ定義 (ContactFormSchema)
- TypeScript 型エクスポート (ContactFormInput)
- バリデーションルール設定

**依存関係**: なし
**優先度**: 🔴 高
**所要時間**: 10 分

---

### Task 2.2: Turnstile 検証ユーティリティ

**ファイル**: `apps/server/src/lib/turnstile.ts`

**実装内容**:

- `verifyTurnstileToken` 関数作成
- Cloudflare Turnstile API 呼び出し
- エラーハンドリング

**依存関係**: なし
**優先度**: 🔴 高
**所要時間**: 15 分

---

### Task 2.3: SendGrid メール送信ユーティリティ

**ファイル**: `apps/server/src/lib/sendgrid.ts`

**実装内容**:

- SendGrid SDK のインストール (`@sendgrid/mail`)
- `sendAdminNotification` 関数 (管理者通知)
- `sendUserConfirmation` 関数 (ユーザー自動返信)
- メールテンプレート実装
- エラーハンドリング

**依存関係**: なし
**優先度**: 🔴 高
**所要時間**: 30 分

---

### Task 2.4: tRPC contact ルーター作成

**ファイル**: `packages/api/src/routers/contact.ts`

**実装内容**:

- `contactRouter` 作成
- `send` mutation 実装
  1. Turnstile 検証
  2. 入力バリデーション
  3. SendGrid メール送信
  4. エラーハンドリング
- レスポンス型定義

**依存関係**:

- Task 2.1 (スキーマ)
- Task 2.2 (Turnstile)
- Task 2.3 (SendGrid)

**優先度**: 🔴 高
**所要時間**: 30 分

---

### Task 2.5: メインルーターへの統合

**ファイル**: `packages/api/src/routers/index.ts`

**実装内容**:

- contactRouter を export
- ルーター統合

**依存関係**: Task 2.4
**優先度**: 🔴 高
**所要時間**: 5 分

---

## Phase 3: フロントエンド実装

### Task 3.1: Turnstile コンポーネント作成

**ファイル**: `apps/web/src/components/turnstile.tsx`

**実装内容**:

- Turnstile React コンポーネント
- スクリプト動的読み込み
- onVerify, onError コールバック実装
- TypeScript 型定義

**依存関係**: なし
**優先度**: 🔴 高
**所要時間**: 20 分

---

### Task 3.2: フォーム UI コンポーネント (shadcn/ui)

**必要なコンポーネント**:

- Button
- Input
- Textarea
- Label

**コマンド**:

```bash
cd apps/web
npx shadcn@latest add button input textarea label
```

**依存関係**: なし
**優先度**: 🟡 中
**所要時間**: 10 分

---

### Task 3.3: お問い合わせフォームページ作成

**ファイル**: `apps/web/src/app/contact/page.tsx`

**実装内容**:

- `@tanstack/react-form` でフォーム管理
- zod バリデーション統合
- Turnstile コンポーネント統合
- tRPC mutation 呼び出し
- ローディング状態管理
- エラーハンドリング
- 成功時の toast 表示

**依存関係**:

- Task 3.1 (Turnstile コンポーネント)
- Task 3.2 (UI コンポーネント)
- Task 2.4 (tRPC ルーター)

**優先度**: 🔴 高
**所要時間**: 60 分

---

### Task 3.4: tRPC クライアント設定確認

**ファイル**: `apps/web/src/lib/trpc.ts`

**確認事項**:

- tRPC クライアント設定が正しいか
- `NEXT_PUBLIC_SERVER_URL` が正しく読み込まれているか
- contactRouter が型として利用可能か

**依存関係**: Task 2.5
**優先度**: 🟡 中
**所要時間**: 10 分

---

## Phase 4: テスト

### Task 4.1: ローカル環境セットアップ

**手順**:

1. 環境変数ファイル作成
   - `apps/server/.env` (SendGrid, Turnstile の実際のキー)
   - `apps/web/.env.local` (Turnstile サイトキー)
2. 依存関係インストール: `pnpm install`
3. 開発サーバー起動: `pnpm dev`

**依存関係**: Task 1.1
**優先度**: 🔴 高
**所要時間**: 15 分

---

### Task 4.2: 正常系テスト

**テストケース**:

- [ ] フォームページにアクセス可能 (http://localhost:3001/contact)
- [ ] Turnstile が正常に表示される
- [ ] 全項目を正常に入力して送信
- [ ] 管理者メールが届く
- [ ] ユーザー宛メールが届く
- [ ] 成功 toast が表示される
- [ ] フォームがリセットされる

**依存関係**: Phase 3 完了
**優先度**: 🔴 高
**所要時間**: 30 分

---

### Task 4.3: 異常系テスト

**テストケース**:

- [ ] 名前空欄で送信 → エラー表示
- [ ] メール形式不正 → エラー表示
- [ ] 本文 9 文字以下 → エラー表示
- [ ] 本文 5001 文字以上 → エラー表示
- [ ] Turnstile 未完了で送信 → エラー表示
- [ ] 不正な Turnstile トークン → エラー表示
- [ ] SendGrid API キー不正 → 500 エラー

**依存関係**: Task 4.2
**優先度**: 🟡 中
**所要時間**: 30 分

---

### Task 4.4: 型チェックとリント

**コマンド**:

```bash
pnpm check-types
pnpm check
```

**確認事項**:

- TypeScript エラーがないこと
- Biome のリントエラーがないこと

**依存関係**: Phase 3 完了
**優先度**: 🔴 高
**所要時間**: 5 分

---

## Phase 5: デプロイ準備

### Task 5.1: 依存関係の追加確認

**必要なパッケージ**:

- `@sendgrid/mail` (apps/server)
- Turnstile 用の型定義 (必要に応じて)

**コマンド**:

```bash
cd apps/server
pnpm add @sendgrid/mail
```

**依存関係**: なし
**優先度**: 🔴 高
**所要時間**: 5 分

---

### Task 5.2: Cloudflare Workers 環境変数設定

**手順**:

```bash
cd apps/server
wrangler secret put SENDGRID_API_KEY
wrangler secret put TURNSTILE_SECRET
wrangler secret put FROM_EMAIL
wrangler secret put ADMIN_EMAIL
wrangler secret put SITE_NAME
wrangler secret put CORS_ORIGIN
```

**依存関係**: Task 4.2 完了
**優先度**: 🟡 中
**所要時間**: 10 分

---

### Task 5.3: Cloudflare Pages 環境変数設定

**設定項目** (Cloudflare Pages Dashboard):

- `NEXT_PUBLIC_TURNSTILE_SITE_KEY`
- `NEXT_PUBLIC_SERVER_URL` (本番 server URL)

**依存関係**: Task 5.2
**優先度**: 🟡 中
**所要時間**: 5 分

---

### Task 5.4: デプロイとテスト

**手順**:

1. Server デプロイ: `cd apps/server && pnpm deploy`
2. Web デプロイ: `cd apps/web && pnpm deploy`
3. 本番環境でのテスト実行

**依存関係**: Task 5.2, 5.3
**優先度**: 🟡 中
**所要時間**: 30 分

---

## 📊 進捗管理

### 進捗サマリー

| Phase    | タスク数 | 完了  | 残り   | 進捗率  |
| -------- | -------- | ----- | ------ | ------- |
| Phase 1  | 4        | 3     | 1      | 75%     |
| Phase 2  | 5        | 0     | 5      | 0%      |
| Phase 3  | 4        | 0     | 4      | 0%      |
| Phase 4  | 4        | 0     | 4      | 0%      |
| Phase 5  | 4        | 0     | 4      | 0%      |
| **合計** | **21**   | **3** | **18** | **14%** |

### 推定所要時間

- Phase 1: 5 分
- Phase 2: 90 分
- Phase 3: 100 分
- Phase 4: 80 分
- Phase 5: 50 分

**合計推定時間**: 約 5.5 時間

---

## 🎯 次のアクション

1. **Task 1.1**: 環境変数サンプルファイル作成 (5 分)
2. **Task 2.1**: 共通スキーマ定義 (10 分)
3. **Task 2.2**: Turnstile 検証ユーティリティ (15 分)
4. **Task 2.3**: SendGrid メール送信ユーティリティ (30 分)
5. **Task 2.4**: tRPC contact ルーター作成 (30 分)

---

## 📝 備考

- 各タスク完了後は git commit を推奨
- Phase 2 完了後、Phase 3 に進む前に一度コミット
- Phase 4 のテストで問題が見つかった場合は、該当タスクに戻って修正
- デプロイ前に必ず `pnpm check-types` と `pnpm check` を実行

---

**作成者**: AI Assistant
**最終更新**: 2025-11-01 21:05
