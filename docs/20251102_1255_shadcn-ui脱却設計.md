# shadcn/ui 脱却設計ドキュメント

作成日: 2025-11-02
作成者: Claude Code
プロジェクト: next-resend-app

## 1. 目的

本プロジェクトにおける shadcn/ui の使用を見直し、依存関係を削減または排除することで、以下の目標を達成する：

1. **バンドルサイズの最適化**: 未使用のコンポーネントや過剰な依存関係を削減
2. **メンテナンス性の向上**: 外部依存を減らし、プロジェクト固有のニーズに特化したコンポーネント設計
3. **学習とカスタマイズの容易性**: shadcn/ui の抽象化レイヤーを排除し、直接的な実装を理解しやすくする

## 2. 現状分析

### 2.1 使用中のコンポーネント（9個）

プロジェクトでは現在、以下の shadcn/ui コンポーネントを使用しています：

| コンポーネント | ファイルサイズ | Radix UI 依存 | CVA 使用 | 実際の使用箇所 |
|--------------|--------------|--------------|---------|---------------|
| button.tsx | 2.0KB | ✅ Slot | ✅ | contact/page.tsx, mode-toggle.tsx |
| input.tsx | 940B | ❌ | ❌ | contact/page.tsx |
| textarea.tsx | 743B | ❌ | ❌ | contact/page.tsx |
| label.tsx | 575B | ✅ Label | ❌ | contact/page.tsx |
| card.tsx | 1.9KB | ❌ | ❌ | **未使用** |
| dropdown-menu.tsx | 7.9KB | ✅ 完全依存 | ❌ | mode-toggle.tsx |
| checkbox.tsx | 1.2KB | ✅ Checkbox | ❌ | **未使用** |
| skeleton.tsx | 264B | ❌ | ❌ | **未使用** |
| sonner.tsx | 531B | ❌ (sonner使用) | ❌ | 全体（toast表示） |

### 2.2 依存関係マッピング

#### Radix UI 依存
```
radix-ui (^1.4.2) - 統合パッケージ
├─ Slot → button.tsx
├─ Label → label.tsx
├─ Checkbox → checkbox.tsx
└─ DropdownMenu → dropdown-menu.tsx (重度依存)

@radix-ui/react-label (^2.1.7) - 個別パッケージ
@radix-ui/react-slot (^1.2.3) - 個別パッケージ
```

#### その他の依存
```
class-variance-authority (^0.7.1) - Buttonのvariant管理
clsx (^2.1.1) - クラス名結合
tailwind-merge (^3.3.1) - Tailwindクラス最適化
lucide-react (^0.546.0) - アイコン
sonner (^2.0.5) - Toast通知
```

### 2.3 使用状況詳細

#### 使用中のコンポーネント（5個）
1. **Button** - お問い合わせフォーム送信、テーマ切り替えトリガー
2. **Input** - 名前、メールアドレス入力
3. **Textarea** - お問い合わせ内容入力
4. **Label** - フォームラベル
5. **DropdownMenu** - テーマ切り替えメニュー（Light/Dark/System）

#### 未使用のコンポーネント（4個）
1. **Card** - インストール済みだが未使用
2. **Checkbox** - インストール済みだが未使用
3. **Skeleton** - インストール済みだが未使用
4. **sonner.tsx** - Toast通知用のラッパー（実際は `toast()` 関数経由で使用）

### 2.4 Radix UI への依存度分析

| 依存度 | コンポーネント | 理由 |
|--------|--------------|------|
| **高** | DropdownMenu | Radix UI の Portal, Trigger, Content, Item などを完全に依存 |
| **中** | Button | Slot による asChild パターンのみ使用 |
| **中** | Label | htmlFor 属性のアクセシビリティ向上 |
| **中** | Checkbox | Indicator と状態管理 |
| **低** | Input | ネイティブ HTML `<input>` のスタイリングのみ |
| **低** | Textarea | ネイティブ HTML `<textarea>` のスタイリングのみ |
| **低** | Card | ネイティブ HTML `<div>` のスタイリングのみ |
| **低** | Skeleton | ネイティブ HTML `<div>` のスタイリングのみ |
| **外部** | sonner | sonner ライブラリへの依存（Radix UI 不使用） |

## 3. 脱却戦略

### 3.1 段階的アプローチ（推奨）

プロジェクトの規模と現在の使用状況を考慮し、**段階的な移行**を推奨します。

#### Phase 1: 未使用コンポーネントの削除（即時実行可能）

**削除対象:**
- `apps/web/src/components/ui/card.tsx`
- `apps/web/src/components/ui/checkbox.tsx`
- `apps/web/src/components/ui/skeleton.tsx`

**影響:** なし（未使用のため）

**手順:**
```bash
rm apps/web/src/components/ui/card.tsx
rm apps/web/src/components/ui/checkbox.tsx
rm apps/web/src/components/ui/skeleton.tsx
```

#### Phase 2: 低依存コンポーネントの内製化（短期）

**対象:**
- Input（940B、Radix UI 不使用）
- Textarea（743B、Radix UI 不使用）

**戦略:** これらは既にネイティブ HTML 要素をラップしているだけなので、shadcn/ui の型定義や cn 関数を残したまま、単純にコピーして保持する。

**メリット:**
- shadcn/ui から独立
- バンドルサイズへの影響なし
- カスタマイズが容易

**実装例（Input）:**
```typescript
// apps/web/src/components/ui/input.tsx
import type * as React from "react";
import { cn } from "@/lib/utils";

export function Input({
  className,
  type,
  ...props
}: React.ComponentProps<"input">) {
  return (
    <input
      type={type}
      className={cn(
        "flex h-9 w-full min-w-0 rounded-md border border-input bg-transparent px-3 py-1 text-base shadow-xs outline-none transition-[color,box-shadow] selection:bg-primary selection:text-primary-foreground file:inline-flex file:h-7 file:border-0 file:bg-transparent file:font-medium file:text-foreground file:text-sm placeholder:text-muted-foreground disabled:pointer-events-none disabled:cursor-not-allowed disabled:opacity-50 md:text-sm dark:bg-input/30",
        "focus-visible:border-ring focus-visible:ring-[3px] focus-visible:ring-ring/50",
        "aria-invalid:border-destructive aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40",
        className,
      )}
      {...props}
    />
  );
}
```

#### Phase 3: 中依存コンポーネントの評価（中期）

**対象:**
- Button（Radix UI Slot 使用）
- Label（Radix UI Label 使用）

**戦略A: Radix UI を保持**
- Button の `asChild` パターンは便利なので、Radix UI Slot を継続使用
- Label のアクセシビリティ機能は有用なので、Radix UI Label を継続使用
- CVA によるバリアント管理も継続

**戦略B: 完全内製化**
- asChild パターンを削除し、通常の Button に簡素化
- Label はネイティブ `<label>` に置き換え
- CVA を削除し、Tailwind の variants で管理

**推奨:** 戦略A（Radix UI を保持）
- 現在の使用箇所は少なく、機能性が高い
- asChild パターンは他のコンポーネントでも有用
- バンドルサイズへの影響は最小限（Slot と Label のみ）

#### Phase 4: 高依存コンポーネントの代替（長期）

**対象:**
- DropdownMenu（Radix UI に完全依存、7.9KB）

**現在の使用箇所:**
- `apps/web/src/components/mode-toggle.tsx` - テーマ切り替えのみ

**戦略A: 代替ライブラリの採用**

選択肢:
1. **Headless UI** (@headlessui/react)
   - Radix UI と同様のアクセシビリティ機能
   - より軽量
   - Tailwind との統合が優れている

2. **React Aria Components** (@react-aria/components)
   - Adobe 製の高品質アクセシビリティライブラリ
   - より低レベルな制御が可能

3. **Ariakit** (ariakit)
   - 軽量で柔軟
   - React Hooks ベース

**戦略B: カスタム実装**

シンプルなドロップダウンメニューを自作:
```typescript
// 例: シンプルなテーマ切り替え
export function ModeToggle() {
  const [open, setOpen] = useState(false);
  const { setTheme } = useTheme();
  const ref = useRef<HTMLDivElement>(null);

  // クリック外検出
  useEffect(() => {
    function handleClickOutside(event: MouseEvent) {
      if (ref.current && !ref.current.contains(event.target as Node)) {
        setOpen(false);
      }
    }
    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, []);

  return (
    <div ref={ref} className="relative">
      <Button
        variant="outline"
        size="icon"
        onClick={() => setOpen(!open)}
      >
        <Sun className="rotate-0 scale-100 dark:-rotate-90 dark:scale-0" />
        <Moon className="absolute rotate-90 scale-0 dark:rotate-0 dark:scale-100" />
      </Button>
      {open && (
        <div className="absolute right-0 mt-2 w-48 rounded-md bg-popover p-1 shadow-md border">
          <button
            onClick={() => { setTheme("light"); setOpen(false); }}
            className="w-full px-2 py-1.5 text-left hover:bg-accent rounded-sm"
          >
            Light
          </button>
          <button
            onClick={() => { setTheme("dark"); setOpen(false); }}
            className="w-full px-2 py-1.5 text-left hover:bg-accent rounded-sm"
          >
            Dark
          </button>
          <button
            onClick={() => { setTheme("system"); setOpen(false); }}
            className="w-full px-2 py-1.5 text-left hover:bg-accent rounded-sm"
          >
            System
          </button>
        </div>
      )}
    </div>
  );
}
```

**推奨:** 戦略B（カスタム実装）
- テーマ切り替えのみという単純な用途
- 7.9KB の削減効果
- アクセシビリティは `aria-*` 属性で補完可能

### 3.2 完全削除アプローチ（上級者向け）

すべての shadcn/ui コンポーネントを削除し、完全に自前で実装する戦略。

**メリット:**
- 完全な制御とカスタマイズ性
- 最小限のバンドルサイズ
- 依存関係の削減

**デメリット:**
- 開発工数の増加
- アクセシビリティの実装負担
- バグのリスク

**推奨度:** ❌ 現時点では非推奨
- プロジェクト規模が小さい
- 使用コンポーネントも限定的
- Radix UI の品質は高く、自前実装のメリットが少ない

## 4. 推奨実装プラン

### 4.1 即時実行（Phase 1）

**作業内容:** 未使用コンポーネントの削除

```bash
# 未使用コンポーネントを削除
rm apps/web/src/components/ui/card.tsx
rm apps/web/src/components/ui/checkbox.tsx
rm apps/web/src/components/ui/skeleton.tsx

# components.json から削除（必要に応じて）
# 特に設定変更は不要
```

**期待効果:**
- 3.4KB のコード削減
- メンテナンス対象の削減

**リスク:** なし

### 4.2 短期実行（Phase 2 + Phase 4）

**作業内容:**
1. Input と Textarea はそのまま保持（既に内製化されているため）
2. DropdownMenu をカスタム実装に置き換え

**実装手順:**

#### ステップ 1: カスタム ModeToggle の作成

```typescript
// apps/web/src/components/mode-toggle-custom.tsx
"use client";

import { Moon, Sun } from "lucide-react";
import { useTheme } from "next-themes";
import { useState, useRef, useEffect } from "react";
import { Button } from "@/components/ui/button";

export function ModeToggle() {
  const [open, setOpen] = useState(false);
  const { setTheme } = useTheme();
  const ref = useRef<HTMLDivElement>(null);

  useEffect(() => {
    function handleClickOutside(event: MouseEvent) {
      if (ref.current && !ref.current.contains(event.target as Node)) {
        setOpen(false);
      }
    }
    if (open) {
      document.addEventListener("mousedown", handleClickOutside);
      return () => document.removeEventListener("mousedown", handleClickOutside);
    }
  }, [open]);

  const handleSelect = (theme: string) => {
    setTheme(theme);
    setOpen(false);
  };

  return (
    <div ref={ref} className="relative">
      <Button
        variant="outline"
        size="icon"
        onClick={() => setOpen(!open)}
        aria-expanded={open}
        aria-haspopup="menu"
      >
        <Sun className="h-[1.2rem] w-[1.2rem] rotate-0 scale-100 transition-all dark:-rotate-90 dark:scale-0" />
        <Moon className="absolute h-[1.2rem] w-[1.2rem] rotate-90 scale-0 transition-all dark:rotate-0 dark:scale-100" />
        <span className="sr-only">Toggle theme</span>
      </Button>
      {open && (
        <div
          className="absolute right-0 mt-2 min-w-[8rem] rounded-md border bg-popover p-1 text-popover-foreground shadow-md z-50"
          role="menu"
        >
          <button
            onClick={() => handleSelect("light")}
            className="relative flex w-full cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none hover:bg-accent hover:text-accent-foreground"
            role="menuitem"
          >
            Light
          </button>
          <button
            onClick={() => handleSelect("dark")}
            className="relative flex w-full cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none hover:bg-accent hover:text-accent-foreground"
            role="menuitem"
          >
            Dark
          </button>
          <button
            onClick={() => handleSelect("system")}
            className="relative flex w-full cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none hover:bg-accent hover:text-accent-foreground"
            role="menuitem"
          >
            System
          </button>
        </div>
      )}
    </div>
  );
}
```

#### ステップ 2: DropdownMenu の削除

```bash
# dropdown-menu.tsx を削除
rm apps/web/src/components/ui/dropdown-menu.tsx

# mode-toggle.tsx のインポートを更新（手動）
# または mode-toggle-custom.tsx をリネーム
```

#### ステップ 3: 依存関係のクリーンアップ

```bash
cd apps/web

# 不要になったパッケージを確認
pnpm why radix-ui
pnpm why @radix-ui/react-label
pnpm why @radix-ui/react-slot

# 他のコンポーネントで使用されていなければ削除
pnpm remove radix-ui
# ただし、Button と Label で Radix UI を使用している場合は残す
```

**期待効果:**
- 7.9KB のコード削減（DropdownMenu）
- Radix UI の依存をButton と Label のみに限定

**リスク:**
- アクセシビリティの低下（ARIA 属性で補完）
- キーボードナビゲーションの未実装（必要に応じて追加）

### 4.3 中長期実行（Phase 3 - オプション）

**作業内容:** Button と Label の完全内製化

**実装判断基準:**
- 他のページでも多用する場合 → Radix UI を保持
- 単純なフォームのみの場合 → 内製化を検討

**現時点での推奨:** Radix UI を保持（asChild パターンは便利）

## 5. 依存関係の整理方針

### 5.1 保持すべき依存関係

| パッケージ | 理由 | 使用箇所 |
|-----------|------|---------|
| clsx | クラス名の条件付き結合に便利 | cn 関数 |
| tailwind-merge | Tailwind クラスの重複解決 | cn 関数 |
| lucide-react | 高品質なアイコンライブラリ | 全体 |
| sonner | 軽量で優れたToast実装 | 全体 |

### 5.2 検討すべき依存関係

| パッケージ | 現在の使用 | 代替案 | 推奨 |
|-----------|-----------|--------|------|
| radix-ui | Button, Label | ネイティブHTML | 保持 |
| @radix-ui/react-label | Label | `<label>` | 保持 |
| @radix-ui/react-slot | Button asChild | 削除 | 保持 |
| class-variance-authority | Button variants | Tailwind variants | 保持 |

### 5.3 削除推奨の依存関係

現時点で削除できる shadcn/ui 関連：
- DropdownMenu（カスタム実装に置き換え後）

## 6. バンドルサイズへの影響試算

### 6.1 現状のバンドルサイズ（推定）

```
shadcn/ui コンポーネント合計: ~15KB (gzip前)
├─ button.tsx: 2.0KB
├─ input.tsx: 0.9KB
├─ textarea.tsx: 0.7KB
├─ label.tsx: 0.6KB
├─ dropdown-menu.tsx: 7.9KB
├─ card.tsx: 1.9KB (未使用)
├─ checkbox.tsx: 1.2KB (未使用)
├─ skeleton.tsx: 0.3KB (未使用)
└─ sonner.tsx: 0.5KB

Radix UI ランタイム: ~20KB (gzip前)
CVA: ~5KB (gzip前)

合計: ~40KB (gzip前) → ~12KB (gzip後)
```

### 6.2 Phase 1 実施後

```
削減: 3.4KB (card, checkbox, skeleton)
残り: ~36.6KB (gzip前) → ~11KB (gzip後)
```

### 6.3 Phase 2 + Phase 4 実施後

```
削減: 7.9KB (dropdown-menu) + Radix UI の一部
残り: ~28.7KB (gzip前) → ~8.5KB (gzip後)
```

### 6.4 完全削除後（Phase 3 含む）

```
削減: すべての Radix UI + CVA
残り: ~10KB (gzip前) → ~3KB (gzip後)
```

**結論:** 段階的アプローチ（Phase 1 + 2 + 4）で約 25% のバンドルサイズ削減が可能。

## 7. アクセシビリティへの配慮

shadcn/ui および Radix UI は優れたアクセシビリティを提供しています。カスタム実装時は以下を遵守すること：

### 7.1 必須のARIA属性

#### DropdownMenu の代替実装

```typescript
// トリガーボタン
<button
  aria-expanded={open}
  aria-haspopup="menu"
  aria-controls="theme-menu"
>

// メニュー本体
<div
  id="theme-menu"
  role="menu"
  aria-orientation="vertical"
>

// メニューアイテム
<button role="menuitem">
```

#### Label の代替実装

```typescript
// Radix UI Label の代わり
<label htmlFor="email" className="...">
  メールアドレス
</label>
<input id="email" type="email" aria-describedby="email-error" />
<span id="email-error" role="alert">エラーメッセージ</span>
```

### 7.2 キーボードナビゲーション

カスタム DropdownMenu には以下のキーボードサポートを実装すること：

- **Escape**: メニューを閉じる
- **ArrowDown**: 次の項目にフォーカス
- **ArrowUp**: 前の項目にフォーカス
- **Enter / Space**: 項目を選択
- **Tab**: メニューを閉じてフォーカスを移動

### 7.3 フォーカス管理

- メニューを開いたときに最初の項目にフォーカス
- メニューを閉じたときにトリガーボタンにフォーカスを戻す

## 8. 実装チェックリスト

### Phase 1: 未使用コンポーネント削除

- [ ] card.tsx を削除
- [ ] checkbox.tsx を削除
- [ ] skeleton.tsx を削除
- [ ] 型エラーがないことを確認（`pnpm check-types`）
- [ ] ビルドが成功することを確認（`pnpm build`）
- [ ] Git コミット

### Phase 2 + 4: DropdownMenu のカスタム実装

- [ ] mode-toggle-custom.tsx を作成
- [ ] カスタム実装をテスト（Light/Dark/System切り替え）
- [ ] アクセシビリティを確認（ARIA属性）
- [ ] キーボードナビゲーションをテスト（Escape, Enter）
- [ ] mode-toggle.tsx をカスタム版に置き換え
- [ ] dropdown-menu.tsx を削除
- [ ] 型エラーがないことを確認
- [ ] ビルドが成功することを確認
- [ ] Git コミット

### Phase 3: Button と Label の評価（オプション）

- [ ] Button の asChild 使用箇所を調査
- [ ] Label のアクセシビリティ要件を確認
- [ ] 内製化のメリット・デメリットを再評価
- [ ] 必要に応じて実装
- [ ] Git コミット

### 最終確認

- [ ] すべてのページが正常に動作
- [ ] アクセシビリティテスト（スクリーンリーダー、キーボード操作）
- [ ] バンドルサイズを測定（`pnpm build` 後の .next/static を確認）
- [ ] パフォーマンステスト（Lighthouse）
- [ ] 本番環境へのデプロイ

## 9. リスクと対策

### 9.1 アクセシビリティの低下

**リスク:** カスタム実装により WCAG 2.1 準拠が困難になる

**対策:**
- ARIA 属性を適切に実装
- axe DevTools でテスト
- スクリーンリーダーでテスト（NVDA, JAWS, VoiceOver）

### 9.2 ブラウザ互換性

**リスク:** Radix UI が対応していたエッジケースに未対応

**対策:**
- 主要ブラウザでテスト（Chrome, Firefox, Safari, Edge）
- モバイルブラウザでテスト（iOS Safari, Chrome Android）
- BrowserStack などのクロスブラウザテストツールを使用

### 9.3 開発工数の増加

**リスク:** カスタム実装に時間がかかる

**対策:**
- 段階的アプローチで小さく始める
- 既存の実装を参考にする
- 必要に応じて Headless UI などの代替ライブラリを検討

## 10. 代替ライブラリの比較

将来的により多くのコンポーネントが必要になった場合の選択肢：

| ライブラリ | 特徴 | バンドルサイズ | アクセシビリティ | 推奨度 |
|-----------|------|--------------|----------------|-------|
| **Headless UI** | Tailwind 公式、軽量 | 小 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| **Radix UI** | 現在使用中、高品質 | 中 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ |
| **React Aria** | Adobe 製、低レベル | 大 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ |
| **Ariakit** | 軽量、Hooks ベース | 小 | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ |
| **Mantine** | 完全なUIライブラリ | 大 | ⭐⭐⭐⭐ | ⭐⭐ |
| **Chakra UI** | 完全なUIライブラリ | 大 | ⭐⭐⭐⭐ | ⭐⭐ |

**推奨:** Headless UI（Tailwind との統合が優れており、学習コストが低い）

## 11. 結論

### 推奨される最終構成

```
apps/web/src/components/ui/
├─ button.tsx          ✅ 保持（Radix UI Slot 使用）
├─ input.tsx           ✅ 保持（既に内製化済み）
├─ textarea.tsx        ✅ 保持（既に内製化済み）
├─ label.tsx           ✅ 保持（Radix UI Label 使用）
└─ sonner.tsx          ✅ 保持（Toast 通知）

apps/web/src/components/
└─ mode-toggle.tsx     ✅ カスタム実装に置き換え

削除:
├─ card.tsx            ❌ 削除（未使用）
├─ checkbox.tsx        ❌ 削除（未使用）
├─ skeleton.tsx        ❌ 削除（未使用）
└─ dropdown-menu.tsx   ❌ 削除（カスタム実装に置き換え）
```

### 依存関係の最終状態

```json
{
  "dependencies": {
    "radix-ui": "^1.4.2",           // Button (Slot), Label のみ
    "class-variance-authority": "^0.7.1",  // Button variants
    "clsx": "^2.1.1",               // cn 関数
    "tailwind-merge": "^3.3.1",     // cn 関数
    "lucide-react": "^0.546.0",     // アイコン
    "sonner": "^2.0.5"              // Toast
  }
}
```

### 期待される効果

1. **バンドルサイズ**: ~11KB 削減（~40KB → ~29KB、gzip前）
2. **メンテナンス性**: 未使用コンポーネントを削除し、シンプルな構成に
3. **柔軟性**: カスタム実装により、プロジェクト固有のニーズに対応しやすい
4. **学習**: Radix UI の抽象化を一部排除し、理解しやすいコードに

### 次のステップ

1. **Phase 1 を即座に実行**: 未使用コンポーネントの削除（リスクなし）
2. **Phase 2 + 4 を短期で実行**: DropdownMenu のカスタム実装（1-2時間）
3. **Phase 3 は保留**: Button と Label は Radix UI を継続使用

この設計により、shadcn/ui への依存を最小限に抑えつつ、高品質なコンポーネントを維持できます。
