# お問い合わせフォーム要件定義書

**構成技術：Cloudflare Workers × OpenNext × SendGrid × Cloudflare Turnstile**

---

## 1. 概要

本システムは、Next.js(App Router 構成)をベースに、Cloudflare Workers 上で稼働するお問い合わせフォームを構築する。  
ユーザーがフォームから送信した内容を、**管理者宛通知メール**と**ユーザー宛自動返信メール**として SendGrid 経由で送信する。  
また、Cloudflare Turnstile によるボット検証を導入し、スパム防止を図る。

---

## 2. システム構成

| 項目           | 使用技術                                       |
| -------------- | ---------------------------------------------- |
| フロントエンド | Next.js 14 (App Router)                        |
| デプロイ       | Cloudflare Workers / Pages (OpenNext 経由)     |
| メール送信     | SendGrid API                                   |
| スパム対策     | Cloudflare Turnstile                           |
| バリデーション | zod                                            |
| ホスティング   | Cloudflare Pages または Workers                |
| 環境変数管理   | Wrangler Secrets / Pages Environment Variables |

---

## 3. 機能要件

### 3.1 お問い合わせフォーム

- **入力項目**
  - 名前（必須、文字列）
  - メールアドレス（必須、形式検証あり）
  - お問い合わせ内容（必須、最大 5,000 文字）
- **フォーム送信時の挙動**
  1. Cloudflare Turnstile によるボット検証
  2. 入力データをバリデーション (zod)
  3. API ルート `/api/contact` に POST 送信
  4. SendGrid 経由でメール送信
  5. 成功／失敗メッセージをフロントに返却
- **UI**
  - Tailwind CSS によるシンプルな構成
  - 成功時／失敗時のメッセージ表示
  - 送信中はボタンを非活性化（`disabled`）

---

### 3.2 メール送信仕様

#### 管理者宛通知メール

| 項目     | 内容                                                     |
| -------- | -------------------------------------------------------- |
| 送信先   | `ADMIN_EMAIL`                                            |
| 件名     | `【SITE_NAME】新しいお問い合わせ: {ユーザー名}`          |
| 本文     | 名前・メール・本文を含むプレーンテキストおよび HTML 形式 |
| Reply-To | ユーザーのメールアドレス                                 |
| 送信元   | `FROM_EMAIL`                                             |

#### ユーザー宛自動返信メール

| 項目   | 内容                                            |
| ------ | ----------------------------------------------- |
| 送信先 | ユーザーが入力したメールアドレス                |
| 件名   | `【SITE_NAME】お問い合わせありがとうございます` |
| 本文   | 問い合わせ内容の控えと感謝メッセージ            |
| 差出人 | `FROM_EMAIL`                                    |

---

## 4. 非機能要件

| 区分         | 要件内容                                                      |
| ------------ | ------------------------------------------------------------- |
| セキュリティ | Turnstile による Bot 対策。API キー・秘密鍵は環境変数に保存。 |
| 可用性       | Cloudflare Workers により高スケーラビリティを確保。           |
| 性能         | 平均レイテンシ 100ms 以内でレスポンス。                       |
| 運用性       | Wrangler または Cloudflare Pages Dashboard で環境変数を管理。 |
| 保守性       | OpenNext 構成で CI/CD 対応可能。GitHub 管理推奨。             |

---

## 5. 環境変数一覧

| 名称                             | 用途                   | 備考                 |
| -------------------------------- | ---------------------- | -------------------- |
| `SENDGRID_API_KEY`               | SendGrid API キー      | Secret 管理          |
| `FROM_EMAIL`                     | 送信元メールアドレス   | ドメイン認証済み推奨 |
| `ADMIN_EMAIL`                    | 管理者宛メールアドレス | 通知受信用           |
| `SITE_NAME`                      | サイト名               | メール件名などに使用 |
| `TURNSTILE_SECRET`               | Turnstile Secret Key   | Cloudflare で発行    |
| `NEXT_PUBLIC_TURNSTILE_SITE_KEY` | Turnstile Site Key     | フロントで使用       |

---

## 6. エラーハンドリング

| シナリオ           | レスポンス                  | 対応                            |
| ------------------ | --------------------------- | ------------------------------- |
| 入力値不正         | 400 Bad Request             | バリデーションエラーとして返却  |
| Turnstile 検証失敗 | 400 Bot verification failed | 不正アクセス防止                |
| SendGrid エラー    | 500 Internal Server Error   | メール送信失敗                  |
| 例外発生           | 500 Internal Error          | JSON 形式でエラーメッセージ返却 |

---

## 7. 開発・運用フロー

1. Next.js プロジェクト作成 (`create-next-app`)
2. フォーム UI 実装 (`app/contact/page.tsx`)
3. API ルート実装 (`app/api/contact/route.ts`)
4. SendGrid / Turnstile の環境変数設定
5. OpenNext でビルド (`open-next build`)
6. Cloudflare Workers または Pages にデプロイ (`wrangler deploy` または `pages deploy`)
7. 動作確認（送信テスト・Turnstile 検証）

---

## 8. 将来的な拡張案

| 機能                    | 概要                                 |
| ----------------------- | ------------------------------------ |
| 問い合わせ履歴保存      | Cloudflare KV / R2 / D1 に保存       |
| 管理 UI                 | 問い合わせ一覧・返信ステータス管理   |
| 添付ファイル送信        | ファイルアップロード機能追加         |
| 多言語化                | 日本語／英語切替                     |
| SendGrid テンプレート化 | Dynamic Templates 対応でデザイン統一 |

---

## 9. 想定ディレクトリ構成

```
contact-form/
├─ app/
│  ├─ api/
│  │  └─ contact/
│  │     └─ route.ts
│  └─ contact/
│     └─ page.tsx
├─ .env.local
├─ wrangler.toml
├─ package.json
└─ README.md
```

---

## 10. 品質基準

- ESLint / Prettier 準拠
- 型安全 (TypeScript)
- SendGrid 送信ログは Cloudflare ログまたは Wrangler ログで確認
- Turnstile 動作確認済み
- 本番環境では HTTPS 必須

---

## 11. 作者・ライセンス

- **開発者**: フロントエンドエンジニア（あなた）
- **ライセンス**: MIT（またはプロジェクトに合わせて変更）
- **最終更新日**: 2025-11-01

---
