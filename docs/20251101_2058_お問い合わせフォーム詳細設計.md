# お問い合わせフォーム詳細設計書

**作成日時**: 2025-11-01 20:58
**対象プロジェクト**: next-sendgrid-app

---

## 1. システム設計概要

本設計書は、要件定義書に基づき、Turborepo モノレポ構成における技術的な実装詳細を定義します。

### 1.1 アーキテクチャパターン

```
┌─────────────────────────────────────────────────────────────┐
│                     Cloudflare Edge Network                  │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌──────────────────┐              ┌──────────────────┐     │
│  │   apps/web       │              │  apps/server     │     │
│  │   (Next.js 16)   │─────tRPC────▶│  (Hono + tRPC)  │     │
│  │   Port: 3001     │              │  Port: 3000      │     │
│  └──────────────────┘              └──────────────────┘     │
│          │                                   │               │
│          │                                   │               │
│          ▼                                   ▼               │
│  ┌──────────────────┐              ┌──────────────────┐     │
│  │ Turnstile Widget │              │  packages/api    │     │
│  │  (Bot検証)       │              │  (ビジネスロジック) │   │
│  └──────────────────┘              └──────────────────┘     │
│                                             │               │
│                                             ▼               │
│                                    ┌──────────────────┐     │
│                                    │   SendGrid API   │     │
│                                    │  (メール送信)     │     │
│                                    └──────────────────┘     │
│                                                               │
└─────────────────────────────────────────────────────────────┘
```

---

## 2. ディレクトリ構造

```
next-sendgrid-app/
├── apps/
│   ├── web/
│   │   ├── src/
│   │   │   ├── app/
│   │   │   │   └── contact/
│   │   │   │       └── page.tsx          # お問い合わせページ
│   │   │   ├── components/
│   │   │   │   ├── ui/                   # shadcn/ui コンポーネント
│   │   │   │   └── turnstile.tsx         # Turnstile ウィジェット
│   │   │   └── lib/
│   │   │       └── trpc.ts               # tRPC クライアント設定
│   │   └── .env.local                    # フロントエンド環境変数
│   │
│   └── server/
│       ├── src/
│       │   ├── index.ts                  # Hono サーバーエントリポイント
│       │   └── lib/
│       │       ├── sendgrid.ts           # SendGrid ユーティリティ
│       │       └── turnstile.ts          # Turnstile 検証
│       └── .env                          # サーバー環境変数
│
└── packages/
    └── api/
        └── src/
            ├── routers/
            │   ├── index.ts
            │   └── contact.ts            # contact tRPC ルーター
            └── schemas/
                └── contact.ts            # 共通バリデーションスキーマ
```

---

## 3. データフロー詳細

### 3.1 フォーム送信フロー

```
1. ユーザー入力
   ↓
2. クライアントサイドバリデーション (zod + @tanstack/react-form)
   ↓
3. Turnstile チャレンジ実行
   ↓
4. Turnstile トークン取得
   ↓
5. tRPC contact.send プロシージャ呼び出し
   {
     name: string,
     email: string,
     message: string,
     turnstileToken: string
   }
   ↓
6. サーバーサイド処理 (apps/server)
   ├─ Turnstile トークン検証 (Cloudflare API)
   ├─ 入力バリデーション (zod)
   └─ SendGrid メール送信
       ├─ 管理者宛通知メール
       └─ ユーザー宛自動返信メール
   ↓
7. レスポンス返却
   { success: boolean, message: string }
   ↓
8. フロントエンド
   ├─ 成功: toast 表示 + フォームリセット
   └─ 失敗: エラーメッセージ表示
```

---

## 4. スキーマ定義

### 4.1 共通スキーマ (`packages/api/src/schemas/contact.ts`)

```typescript
import { z } from "zod";

export const ContactFormSchema = z.object({
  name: z.string().min(1, "名前は必須です").max(100, "名前は100文字以内で入力してください"),

  email: z.string().min(1, "メールアドレスは必須です").email("有効なメールアドレスを入力してください"),

  message: z.string().min(10, "お問い合わせ内容は10文字以上入力してください").max(5000, "お問い合わせ内容は5000文字以内で入力してください"),

  turnstileToken: z.string().min(1, "ボット検証が必要です"),
});

export type ContactFormInput = z.infer<typeof ContactFormSchema>;
```

---

## 5. API 設計

### 5.1 tRPC プロシージャ定義 (`packages/api/src/routers/contact.ts`)

```typescript
import { z } from "zod";
import { publicProcedure, router } from "../trpc";
import { ContactFormSchema } from "../schemas/contact";

export const contactRouter = router({
  send: publicProcedure
    .input(ContactFormSchema)
    .output(
      z.object({
        success: z.boolean(),
        message: z.string(),
      })
    )
    .mutation(async ({ input, ctx }) => {
      // 1. Turnstile 検証
      // 2. SendGrid メール送信
      // 3. レスポンス返却
    }),
});
```

### 5.2 エンドポイント

- **URL**: `http://localhost:3000/trpc/contact.send`
- **Method**: POST (tRPC mutation)
- **Content-Type**: application/json

---

## 6. SendGrid メール設計

### 6.1 管理者宛通知メール

```typescript
{
  to: process.env.ADMIN_EMAIL,
  from: process.env.FROM_EMAIL,
  replyTo: input.email,
  subject: `【${process.env.SITE_NAME}】新しいお問い合わせ: ${input.name}`,
  text: `
名前: ${input.name}
メールアドレス: ${input.email}

お問い合わせ内容:
${input.message}

---
送信日時: ${new Date().toLocaleString('ja-JP')}
  `,
  html: `
<h2>新しいお問い合わせ</h2>
<p><strong>名前:</strong> ${input.name}</p>
<p><strong>メールアドレス:</strong> ${input.email}</p>
<h3>お問い合わせ内容</h3>
<p>${input.message.replace(/\n/g, '<br>')}</p>
<hr>
<p><small>送信日時: ${new Date().toLocaleString('ja-JP')}</small></p>
  `
}
```

### 6.2 ユーザー宛自動返信メール

```typescript
{
  to: input.email,
  from: process.env.FROM_EMAIL,
  subject: `【${process.env.SITE_NAME}】お問い合わせありがとうございます`,
  text: `
${input.name} 様

この度は${process.env.SITE_NAME}にお問い合わせいただき、ありがとうございます。
以下の内容でお問い合わせを受け付けました。

---
お問い合わせ内容:
${input.message}
---

担当者より折り返しご連絡いたしますので、
今しばらくお待ちくださいますようお願いいたします。

${process.env.SITE_NAME}
  `,
  html: `
<p>${input.name} 様</p>
<p>この度は<strong>${process.env.SITE_NAME}</strong>にお問い合わせいただき、ありがとうございます。<br>
以下の内容でお問い合わせを受け付けました。</p>
<hr>
<h3>お問い合わせ内容</h3>
<p>${input.message.replace(/\n/g, '<br>')}</p>
<hr>
<p>担当者より折り返しご連絡いたしますので、<br>
今しばらくお待ちくださいますようお願いいたします。</p>
<p><strong>${process.env.SITE_NAME}</strong></p>
  `
}
```

---

## 7. Turnstile 実装

### 7.1 フロントエンド実装 (`apps/web/src/components/turnstile.tsx`)

```typescript
"use client";

import { useEffect, useRef } from "react";

interface TurnstileProps {
  siteKey: string;
  onVerify: (token: string) => void;
  onError?: () => void;
}

export function Turnstile({ siteKey, onVerify, onError }: TurnstileProps) {
  const containerRef = useRef<HTMLDivElement>(null);

  useEffect(() => {
    if (!containerRef.current) return;

    const script = document.createElement("script");
    script.src = "https://challenges.cloudflare.com/turnstile/v0/api.js";
    script.async = true;
    script.defer = true;
    document.body.appendChild(script);

    script.onload = () => {
      if (window.turnstile && containerRef.current) {
        window.turnstile.render(containerRef.current, {
          sitekey: siteKey,
          callback: onVerify,
          "error-callback": onError,
        });
      }
    };

    return () => {
      if (script.parentNode) {
        script.parentNode.removeChild(script);
      }
    };
  }, [siteKey, onVerify, onError]);

  return <div ref={containerRef} />;
}
```

### 7.2 サーバーサイド検証 (`apps/server/src/lib/turnstile.ts`)

```typescript
export async function verifyTurnstileToken(token: string, secret: string): Promise<boolean> {
  const response = await fetch("https://challenges.cloudflare.com/turnstile/v0/siteverify", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
    },
    body: JSON.stringify({
      secret,
      response: token,
    }),
  });

  const data = await response.json();
  return data.success === true;
}
```

---

## 8. 環境変数

### 8.1 サーバー側 (`apps/server/.env`)

```bash
# SendGrid
SENDGRID_API_KEY=SG.xxxxxxxxxxxxxxxxxxxxx
FROM_EMAIL=noreply@example.com
ADMIN_EMAIL=admin@example.com

# Site Info
SITE_NAME=サンプルサイト

# Turnstile
TURNSTILE_SECRET=0x4AAAAAAAxxxxxxxxxxxxxxxxx

# CORS
CORS_ORIGIN=http://localhost:3001
```

### 8.2 フロントエンド側 (`apps/web/.env.local`)

```bash
# Turnstile
NEXT_PUBLIC_TURNSTILE_SITE_KEY=0x4AAAAAAAxxxxxxxxxxxxxxxxx

# tRPC Endpoint
NEXT_PUBLIC_SERVER_URL=http://localhost:3000
```

### 8.3 環境変数サンプルファイル

- `apps/server/.env.example`
- `apps/web/.env.local.example`

上記 2 ファイルを作成し、実際の値を含まない状態で Git にコミットします。

---

## 9. エラーハンドリング

### 9.1 エラーコード設計

| コード | シナリオ             | メッセージ例                                                   |
| ------ | -------------------- | -------------------------------------------------------------- |
| 400    | バリデーションエラー | "名前は必須です", "メールアドレスの形式が正しくありません"     |
| 400    | Turnstile 検証失敗   | "ボット検証に失敗しました。もう一度お試しください"             |
| 500    | SendGrid API エラー  | "メール送信に失敗しました。しばらくしてから再度お試しください" |
| 500    | サーバー内部エラー   | "予期しないエラーが発生しました"                               |

### 9.2 tRPC エラーハンドリング

```typescript
import { TRPCError } from "@trpc/server";

// バリデーションエラー
throw new TRPCError({
  code: "BAD_REQUEST",
  message: "入力内容に誤りがあります",
});

// Turnstile エラー
throw new TRPCError({
  code: "BAD_REQUEST",
  message: "ボット検証に失敗しました",
});

// SendGrid エラー
throw new TRPCError({
  code: "INTERNAL_SERVER_ERROR",
  message: "メール送信に失敗しました",
});
```

### 9.3 フロントエンドエラー表示

```typescript
import { toast } from "sonner";

// 成功
toast.success("お問い合わせを送信しました");

// エラー
toast.error(error.message);
```

---

## 10. UI/UX デザイン

### 10.1 フォームレイアウト

```
┌─────────────────────────────────────────┐
│  お問い合わせフォーム                     │
├─────────────────────────────────────────┤
│                                           │
│  名前 *                                   │
│  [________________________]               │
│                                           │
│  メールアドレス *                         │
│  [________________________]               │
│                                           │
│  お問い合わせ内容 *                       │
│  [________________________]               │
│  [________________________]               │
│  [________________________]               │
│  [________________________]               │
│                                           │
│  [ Turnstile Widget ]                    │
│                                           │
│  [  送信する  ]                           │
│                                           │
└─────────────────────────────────────────┘
```

### 10.2 状態管理

| 状態               | UI 変更                               |
| ------------------ | ------------------------------------- |
| 初期状態           | すべて入力可能、送信ボタン有効        |
| 送信中             | ローディングスピナー表示、ボタン無効  |
| 送信成功           | Toast 表示、フォームリセット          |
| 送信失敗           | エラー Toast 表示、Turnstile リセット |
| バリデーション失敗 | 各フィールド下にエラーメッセージ表示  |

---

## 11. テストシナリオ

### 11.1 正常系テスト

| No. | テストケース        | 期待結果                              |
| --- | ------------------- | ------------------------------------- |
| 1   | 全項目正常入力+送信 | 2 通のメール送信成功、成功 Toast 表示 |
| 2   | フォームリセット    | 送信成功後、フォームが空になる        |
| 3   | Turnstile 正常動作  | チャレンジ表示 → トークン取得成功     |

### 11.2 異常系テスト

| No. | テストケース           | 期待結果                                 |
| --- | ---------------------- | ---------------------------------------- |
| 1   | 名前空欄               | "名前は必須です" エラー表示              |
| 2   | メール形式不正         | "有効なメールアドレスを入力してください" |
| 3   | 本文 9 文字以下        | "10 文字以上入力してください"            |
| 4   | 本文 5001 文字以上     | "5000 文字以内で入力してください"        |
| 5   | Turnstile 未完了で送信 | "ボット検証が必要です"                   |
| 6   | Turnstile トークン不正 | "ボット検証に失敗しました"               |
| 7   | SendGrid API キー不正  | "メール送信に失敗しました"               |

### 11.3 パフォーマンステスト

- フォーム送信 → レスポンス返却: 平均 1〜2 秒以内
- Turnstile チャレンジ完了: 平均 1〜3 秒

---

## 12. セキュリティ対策

### 12.1 実装済み対策

| 項目                   | 対策内容                                         |
| ---------------------- | ------------------------------------------------ |
| Bot 対策               | Cloudflare Turnstile による検証                  |
| CORS                   | 許可されたオリジンからのみリクエスト受付         |
| API キー保護           | 環境変数で管理、コードにハードコーディングしない |
| XSS 対策               | React による自動エスケープ                       |
| 入力サニタイゼーション | zod による厳格なバリデーション                   |

### 12.2 推奨事項

- SendGrid API キーは定期的にローテーション
- FROM_EMAIL は SPF/DKIM/DMARC 認証設定済みドメインを使用
- 本番環境では HTTPS 必須
- レート制限の実装（将来的に Cloudflare Workers KV で実装可能）

---

## 13. デプロイフロー

### 13.1 ローカル開発

```bash
# 1. 環境変数設定
cp apps/server/.env.example apps/server/.env
cp apps/web/.env.local.example apps/web/.env.local
# 各ファイルを編集

# 2. 依存関係インストール
pnpm install

# 3. 開発サーバー起動
pnpm dev

# 4. ブラウザで確認
# Web: http://localhost:3001/contact
# Server: http://localhost:3000
```

### 13.2 Cloudflare Workers へのデプロイ

```bash
# 1. Wrangler でシークレット設定
cd apps/server
wrangler secret put SENDGRID_API_KEY
wrangler secret put TURNSTILE_SECRET
# 他の環境変数も同様に設定

# 2. Server デプロイ
pnpm deploy

# 3. Web デプロイ (OpenNext)
cd ../web
# .env.local の NEXT_PUBLIC_SERVER_URL を本番URLに変更
pnpm deploy
```

### 13.3 動作確認

- [ ] フォームページアクセス可能
- [ ] Turnstile が正常に表示される
- [ ] フォーム送信が成功する
- [ ] 管理者メールが届く
- [ ] ユーザー宛メールが届く
- [ ] エラー時に適切なメッセージが表示される

---

## 14. 保守・運用

### 14.1 ログ確認

```bash
# Cloudflare Workers ログ確認
wrangler tail

# SendGrid 送信ログ
# SendGrid Dashboard > Activity から確認
```

### 14.2 トラブルシューティング

| 問題                     | 原因候補                                 | 解決策                              |
| ------------------------ | ---------------------------------------- | ----------------------------------- |
| メールが届かない         | SendGrid API キー不正、FROM_EMAIL 未認証 | API キー確認、ドメイン認証設定確認  |
| Turnstile が表示されない | Site Key 不正、スクリプト読み込み失敗    | 環境変数確認、ネットワーク確認      |
| CORS エラー              | CORS_ORIGIN 設定ミス                     | 環境変数で正しいオリジンを設定      |
| 500 エラー               | サーバーコード実行エラー                 | Wrangler ログでスタックトレース確認 |

---

## 15. 今後の拡張案

### 15.1 Phase 2 機能

- [ ] 問い合わせ履歴を Cloudflare D1 に保存
- [ ] 管理画面で問い合わせ一覧・詳細表示
- [ ] ステータス管理（未対応・対応中・完了）
- [ ] ファイル添付機能

### 15.2 Phase 3 機能

- [ ] SendGrid Dynamic Templates 対応
- [ ] 多言語化（i18n）
- [ ] メール返信機能
- [ ] カテゴリ選択（お問い合わせ種別）

---

## 16. 参考リンク

- [Next.js Documentation](https://nextjs.org/docs)
- [tRPC Documentation](https://trpc.io/docs)
- [SendGrid API Reference](https://docs.sendgrid.com/api-reference)
- [Cloudflare Turnstile](https://developers.cloudflare.com/turnstile)
- [Hono Documentation](https://hono.dev)
- [Drizzle ORM](https://orm.drizzle.team)

---

**設計者**: AI Assistant
**承認者**: -
**バージョン**: 1.0.0
